name: Deploy Backend to AWS App Runner

on:
  push:
    branches: [ main ]
    paths: [ 'back-end/**' ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: cat-slideshow-api
  ROLE_ARN: arn:aws:iam::776991920768:role/cat_slideshow_deploy

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # <-- required for OIDC

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ env.ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: gha-deploy

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Install dependencies
      working-directory: back-end/cat-slideshow-api
      run: uv sync --frozen --no-dev

    # --- Build-time secrets (for CI steps like Alembic) ---
    # Pull from SSM Parameter Store (SecureString recommended)
    - name: Load build-time parameters from SSM
      id: ssm
      run: |
        SSM_PREFIX="/cat-slideshow/prod"
        PARAMS=(
          "MIGRATIONS_DB_URL"
          "RUNTIME_DB_URL"
          "CAT_IMAGES_AWS_ACCESS_KEY_ID"
          "CAT_IMAGES_AWS_SECRET_ACCESS_KEY"
          "USER_POOL_ID"
          "APP_CLIENT_ID"
          "APPRUNNER_SERVICE_ARN"
        )
        
        for param in "${PARAMS[@]}"; do
          value=$(aws ssm get-parameter \
            --name "${SSM_PREFIX}/${param}" \
            --with-decryption \
            --query 'Parameter.Value' --output text)
          echo "${param}=${value}" >> "$GITHUB_ENV"
        done

    - name: Run database migrations
      working-directory: back-end/cat-slideshow-api
      env:
        MIGRATIONS_DB_URL: ${{ env.MIGRATIONS_DB_URL }}
      run: uv run alembic upgrade head

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build, tag, and push image to Amazon ECR
      working-directory: back-end/cat-slideshow-api
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker buildx build --platform linux/amd64 \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG --push .
        docker buildx build --platform linux/amd64 \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:latest --push .

    # --- Runtime secrets for the App Runner service ---
    # Use external script to build App Runner configuration with SSM parameter ARNs
    - name: Build App Runner configuration
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      run: |
        bash .github/scripts/build-apprunner-config.sh \
          "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest" \
          "/cat-slideshow/prod" \
          > source-config.json

    - name: Update App Runner service
      run: |
        aws apprunner update-service \
          --service-arn "${APPRUNNER_SERVICE_ARN}" \
          --source-configuration file://source-config.json

    - name: Start deployment
      run: aws apprunner start-deployment --service-arn "${APPRUNNER_SERVICE_ARN}"
